#ETIQUETA DE PUERTAS
 "orden"  || '_' ||  "tipo"  || '_' ||  "num_munici" 


#SELECCIONAR PISOS ALTOS SQL
SELECT t.*
FROM tg_construccion_2 t
JOIN (
    SELECT
        cod_mzna,
        cod_lote,
        cod_edific,
        MAX(cod_piso) AS max_piso
    FROM tg_construccion_2
    GROUP BY
        cod_mzna,
        cod_lote,
        cod_edific
) m
ON t.cod_mzna = m.cod_mzna
AND t.cod_lote = m.cod_lote
AND t.cod_edific = m.cod_edific
AND t.cod_piso = m.max_piso;

#SABER SI TIENE VERTICES DUPLICADOS
SELECT
  fid
FROM tg_construccion
WHERE
  geom IS NOT NULL
  AND ST_NPoints(geom) <> ST_NPoints(ST_SnapToGrid(geom, 0));


#SABER SI TIENE GEOMETRIA NULA,VACIA, INVALIDA
SELECT
  fid,
  CASE
    WHEN geom IS NULL THEN 'GEOMETRIA NULA'
    WHEN ST_IsEmpty(geom)=1 THEN 'GEOMETRIA VACIA'
    WHEN ST_IsValid(geom)=0 THEN 'GEOMETRIA INVALIDA'
  END AS estado
FROM tg_construccion
WHERE
  geom IS NULL
  OR ST_IsEmpty(geom)=1
  OR ST_IsValid(geom)=0;



# GEOMETRIAS MULTIPART
SELECT
  fid,
  ST_NumGeometries(geom) AS num_partes
FROM tg_construccion
WHERE ST_NumGeometries(geom) > 1;

#SOLAPAMIENTO DEL MISMO PISO
SELECT
  a.fid AS fid1,
  b.fid AS fid2,
  a.cod_piso,
  ST_Area(ST_Intersection(a.geom, b.geom)) AS area_solapada,
  ST_Intersection(a.geom, b.geom) AS geometry
FROM tg_construccion AS a
JOIN tg_construccion AS b
  ON a.cod_piso = b.cod_piso
 AND a.fid < b.fid
WHERE
  ST_Intersects(a.geom, b.geom)
  AND ST_Area(ST_Intersection(a.geom, b.geom)) > 0.1;

